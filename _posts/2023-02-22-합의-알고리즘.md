---
layout: post
title: 합의 알고리즘
date: 2023-02-22 20:44 +0900
categories: [Blockchain, intro]
tags: [blockchain, concensus algorithm]
render_with_liquid: false
---

## 분산 합의

<br>
블록체인에서 합의는 참여자 중 누구에게 블록을 생성할 권한을 주느냐를 결정하는 것이다. 성공적인 분산 합의가 이루어지기 위해선 두 가지 조건이 만족되어야 한다.

1. 올바른 참가자들 모두에 의해 같은 값으로 결정을 내리면서 합의 과정이 끝나야 한다.
2. 합의의 결과 결정된 값은 임의의 값이 될 수 없고, 적어도 하나의 올바른 참가자에 의해서 제안된 값이어야 한다.

### 분산 합의가 필요한 이유

블록체인 네트워크에 참여하고 있는 참여자들은 네트워크 상황에 따라 메세지를 전달받는 속도가 다르다. 따라서 참여자에 따라 메세지가 연결되는 순서가 다를 수 있으므로, 모든 참가자가 동일한 순서를 가지지 않는다. 이 순서들 중 어느 순서를 따라 결정할 것인지 **합의**가 필요하다.

### 분산 합의의 기술적 문제

분산 합의는 비트코인이 동작하는 방식과 유사하지만 정확히 같지는 않으며 몇가지 기술적 문제들이 있다.

1. 노드가 제거되거나 악의적일 수 있다.
2. peer-to-peer 시스템이나 모든 노드가 서로 연결되어 있지 않다면 네트워크는 아주 불안정해진다.
3. 인터넷 연결 상태가 좋지 않으면 통신 실패 상태가 될 가능성이 있다.
   모든 데이터를 관리하는 하나의 데이터 센터가 없기 때문에 다양한 통신에서 지연이 발생할 수 있다.

### 분산 합의 알고리즘의 종류

다양한 알고리즘이 있지만 대표적으로 알려진 것들은 다음과 같다.

1. **PoW (작업증명)**<br>
   목표값 이하의 해시를 찾는 과정을 무수히 반복함으로써 해당 작업에 참여했음을 증명하는 방식<br>
   e.g. Bitcoin, Etherium, Litecoin, Monero, Zcash
2. **PoS (지분증명)**<br>
   암호화폐를 보유하고 있는 지분율에 비례하여 의사결정 권한을 주는 방식<br>
   e.g. QTUM, Peercoin
3. **DPoS (위임증명)**<br>
   암호화폐 소유자들이 각자의 지분율에 비례하여 투표권을 행사하여 대표자를 선정하고, 이 대표자들이 합의하여 의사결정<br>
   e.g. EOS, Steem, Risk, Ark
4. **PBFT (비잔틴 장애 허용)**<br>
   BFT를 확장한 형태<br>
   e.g. NEO, R3, ICT, Tendermint

다음 절에서 각 알고리즘들의 특징을 보다 더 자세히 알아본다.

<br>

## Proof of Work

<br>

입력으로 들어온 값이 해시 함수를 통과하면 일정한 길이를 갖는 임의의 값으로 출력된다. 해시함수의 출력이 목표 값보다 작은 값이 나오면 채굴에 성공했다고 한다.

### 작업증명 알고리즘의 필요성

네트워크의 모든 노드가 동시에 블록을 만들 수 없게 한다. 작업증명을 통과해야만 블록을 생성할 수 있고, 많은 컴퓨팅 파워가 소모된다. 난이도 조절 알고리즘을 이용하여 약 10분당 1개의 블록이 생성된다. 만약 다수의 참여자가 채굴 과정에 참여하여 어떠한 블록이 동시에 생성된다면, 다음번 체인이 연결된(더 길어지는) 블록체인을 메인 체인으로 선택하게 된다. 가장 긴 체인이 네트워크에서 생성되므로 더 긴 체인을 만들기 위해 경쟁하게 되고, 보통 6개의 블록이 생성되기 전에 경쟁이 종료되므로 `₩6 confirmation` 이라고 부른다. 따라서 자신이 생성한 거래는 이후 5개의 블록이 더 생겨야 해당 트랜잭션이 완전하게 거래됐다는 것을 의미한다.

f를 잘못된 노드의 수라 했을 때, 보통 **3f+1** 이상이 올바른 일을 해야 정상 운영한다는 것으로, 글로벌한 규모의 오픈된 네트워크에서 운영할 수 있는 알고리즘이다.

### 작업증명 알고리즘의 문제점

작업증명 알고리즘은 속도가 느리며 에너지 소모가 심각하다. 한 블럭을 생성하기 위해서 5,000,000 TH/s 이상의 해시 파워가 필요하다. 또한 컴퓨팅 파워가 큰 채굴자의 영향력이 커지는 문제가 있다.

<br>

## Proof of Stake

<br>

작업증명 알고리즘의 문제점을 해결하기 위해 다양한 종류의 합의 알고리즘이 등장했다.

1. **지분증명(PoS)** 은 자신이 가지고 있는 암호화폐의 양에 따라서 블록을 생성할 권한을 주겠다는 것이다.
2. **위임지분증명(DPoS)** 은 지분으로 블록을 생성할 권한을 주지만, 위임된 몇몇의 참여자만 생성할 수 있도록 제한하는 것이다.
3. **권위증명(PoA, Proof of Authority)** 은 네트워크에서 자신의 평판/기여도에 따라서 블록을 생성할 권한을 부여하는 것이다.

이 뿐만 아니라 더 다양한 합의 알고리즘이 제안되었다.

### 지분증명

이 방식에서는 채굴이 일어나지 않기 때문에 채굴자가 존재하지 않고 **검증자(Validator)** 가 존재한다. 검증자가 되기 위해서는 일종의 보증금을 지불하고, 얼마의 지분을 Staking 했냐에 따라 검증자가 선택된다. 이 지분에 비례한 확률로 블록을 생성할 권한을 얻게 되며 보상을 받는다. **Staking한 코인에 대해서 이자를 주는 방식**이라 생각할 수 있다.

### 지분증명 알고리즘의 필요성

작업증명 알고리즘처럼 컴퓨팅 파워를 소모할 필요가 없으므로 에너지 비용이 절감된다. 또한 지분에 비례하여 블록생성의 권한을 얻기 때문에 중앙화 위험이 비교적 감소한다. 또한 **최종성(Finality)** 을 부여해 이미 체인에 연결된 블록들이 변경되기 힘들게 만든다. 마지막으로 공격자의 악의적인 행동이 발각되면 모든 자산을 0으로 만드는 패널티를 부여해 공격이 일어나지 못하도록 한다.

### 지분증명 알고리즘의 문제점

모든 참여자들이 이자를 받기 위해 코인을 보유하기만 하여 유통량이 감소할 수 있다. 또한 보안성이 검증되지 않았다는 단점이 있다.

### 위임지분증명

간접 민주주의 방식이라고 할 수 있다. 투표를 통해 대표(검증자)를 선출하여 권한을 위임하는 것이다. 검증자의 수를 제한하여 높은 수준의 확장성을 제공한다.

## BFT & PBFT

어떠한 합의 알고리즘이 네트워크에서 통용되기 위해선 Safety와 Liveness라는 특성을 가지고 있어야 한다. **Safety**의 의미는 노드 간 합의가 발생했다면 어느 노드가 접근하든 그 값은 동일해야한다는 것이다. **Liveness**는 합의 대상에 문제가 없다면 네트워크 내에서 반드시 합의가 이루어진다는 것이다. 하지만 비동기 네트워크 내에서 이를 모두 만족하는 합의 알고리즘을 설계하는 것이 불가능하다. (FLP Imposibility) 네트워크 내에서 배신자가 있더라도 합의 내용에 문제가 없으려면 어떻게 해야 하는가 라는 `비잔틴 장군 문제 (Byzantine Generals Problem)`를 해결하는 방안으로 제시된 **비잔틴 장애 허용 (BFT) 알고리즘**과 비잔틴 장군 문제가 발생할 수 있는 상황에서도 네트워크의 합의를 보장하는 **실전적 비잔틴 장애 허용 (PBFT) 알고리즘**에 대해 소개한다.

### Byzantine General Problems

비잔티움의 장군들은 각각 자신의 군대를 가지고 있고, 다른 곳에 공격하려는 장소가 있다. 장군들은 공격하거나 후퇴하기 위해서 동의를 얻어야 한다. 각 장군은 합의에 도달하기 위해 동의 혹은 거부를 결정하며 이 결정은 번벅할 수 없고, 모든 장군이 같은 결정을 해야 하며 이를 동시에 시행해야 한다. 하지만 메세지는 늦게 전달되거나, 훼손되거나, 소실될 수 있으며 전달되더라도 어떠한 장군이 악의적으로 행동하기로 선택하여 가짜 메세지를 보낼 수 있다.

### BFT

이를 블록체인에 적용하면, 분산화된 시스템에서 합의를 달성할 수 있는 유일한 방법은 최소 2/3 혹은 그 이상의 신뢰할 수 있는 정직한 네트워크 노드를 확보하는 것이다. 비잔티움 장애 허용 시스템은 일부 노드가 고장나거나 악의적으로 행동하더라도 계속 작동할 수 있다. 이를 구축하는 다양한 방식이 있으며, 블록체인에서 비잔티움 장애 허용 시스템을 보통 합의 알고리즘이라 부른다. 일반적인 예로 작업 증명과 지분 증명을 들 수 있다.
a

### PBFT

Safety를 확보하고 Liveness를 일부 희생하면서, 비동기 네트워크에서도 합의를 이룰 수 있는 알고리즘이 바로 PBFT이다. 즉 네트워크에 배신자 노드가 어느 정도 있다고 해도 네트워크 내에서 이루어지는 합의의 신뢰를 보장하는 알고리즘이다. 현재까지 블록체인 합의 알고리즘 중 BFT방식을 채택했다고 하는 경우 대부분 PBFT 합의 알고리즘을 조금씩 변형한 것이다. PBFT는 비동기 네트워크에서 배신자 노드가 f개 있을 때 총 노드 수가 3f+1개 이상이면 해당 네트워크에서 이루어지는 합의는 신뢰할 수 있다는 것을 수학적으로 증명한 알고리즘이다. 네트워크의 모든 노드는 거래와 같은 합의 대상의 상태를 변화할 것인지 `prepared certificate`와 `commit certificate`라는 두 번의 절차를 거쳐 결정한다.
